name: ðŸŒ™ Release new pre-release version

on: [workflow_dispatch]

jobs:

  publish:
    name: Publish
    runs-on: depot-ubuntu-24.04-arm-16
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Setup PNPM
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version-file: .node-version
      - name: Install dependencies
        run: pnpm install
      - name: Generate pre-release version
        id: generate-pre-release-version
        run: |
          version=$(date +"%Y.%-m.%-d%H%M")
          echo "version=$version" >> $GITHUB_OUTPUT
      - name: Patch package.json version with pre-release version
        run: |
          jq \
            --arg version "${{ steps.generate-pre-release-version.outputs.version }}" \
            --tab '.version = $version' \
            package.json > package.json.tmp \
            && mv package.json.tmp package.json
      - name: Build extension
        run: pnpm run build
      - name: Package pre-release extension
        run: pnpm vsce package --pre-release -o biome.vsix
      - name: Publish to Visual Studio Marketplace
        run: pnpm vsce publish --packagePath biome.vsix
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
      - name: Publish to Open VSX Registry
        run: pnpm exec ovsx publish --packagePath biome.vsix
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}